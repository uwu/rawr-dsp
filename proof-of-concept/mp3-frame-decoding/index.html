<script type="module">

	//import { MPEGDecoder } from "https://esm.sh/mpg123-decoder";
	import CodecParser from "https://esm.sh/codec-parser";

	const onlyMp3Data = new Uint8Array(await (await fetch("kshmr.mp3")).arrayBuffer());

	// decode full for reference
	const ctx = new AudioContext();
	const fullDec = await ctx.decodeAudioData(onlyMp3Data.slice().buffer);
	console.log("decoded", onlyMp3Data, "into", fullDec, "with left channel content", fullDec.getChannelData(0));

	// split into little chunks, as if it came over the network
	const slices = [];
	for (let i = 0; i < onlyMp3Data.length; i += 4096)
	{
		slices.push(onlyMp3Data.slice(i, i + 4096));
	}

	console.log("split into chunks of 4096 bytes :)", slices);

	const parser = new CodecParser("audio/mpeg", {
		enableLogging: true
	});

	const frames = [];
	for (const slice of slices)
	{
		const f = [...parser.parseChunk(slice)];
		if (f.length) console.log(`got ${f.length} frames!`);
		frames.push(f)
	}

	console.log("parsed frames: ", frames);

	const buffers = [];
	for (const chunk of frames)
	{
		// chunk of a few frames together
		// assume that codec-parser groups the frames such that each chunk is parseable alone
		const buf = new Uint8Array(chunk.map(f => f.data.length).reduce((a, b) => a + b));
		let seek = 0;
		for (const b of chunk)
		{
			buf.set(b.data, seek);
			seek += b.data.length;
		}

		buffers.push(await ctx.decodeAudioData(buf.buffer));
	}

	console.log("decoded each chunk: ", buffers);

	console.log("left channel:", buffers.map(b => b.getChannelData(0)));

	console.log("YOU MUST CLICK THE PAGE NOW to allow the audio context to start.");

	await new Promise(res => window.onclick = res);

	const bigBuffer = new AudioBuffer({
		length: buffers.map(b => b.length).reduce((a, b) => a + b),
		sampleRate: buffers[0].sampleRate,
		numberOfChannels: buffers[0].numberOfChannels
	});

	let seek = 0;
	for (const buf of buffers)
	{
		for (let i = 0; i < buf.numberOfChannels; i++)
			bigBuffer.copyToChannel(buf.getChannelData(i), i, seek);
		seek += buf.length;
	}

	const source = ctx.createBufferSource();
	source.buffer = bigBuffer;
	source.connect(ctx.destination);
	source.start();

	console.log("//TODO: fix the leading zeroes in this.");

</script>