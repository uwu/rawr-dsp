<script type="module">
	import {onlyMp3Data} from "./test-remove-id3.js";

	// get full decoded file for reference
	const fullDec = await new AudioContext().decodeAudioData(onlyMp3Data.slice().buffer);

	// sources:
	// https://en.wikipedia.org/wiki/MP3#/media/File:Mp3filestructure.svg
	// https://www.datavoyage.com/mpgscript/mpeghdr.htm

	const frames = Array.from((function* mp3Frames() {

		// eof (or no space for header left in the file)
		for (let i = 0; i + 3 < onlyMp3Data.length; i++) {
			if (onlyMp3Data[i] !== 0xFF || onlyMp3Data[i + 1] & 0xF0)
				// not sync byte, continue
				continue;

			// i  i+1                         i+2                   i+3
			// FF,F v       ll    e,          bbbb    ff   p   x,   mm   ee       c         o        ee
			// sync version layer error check bitrate freq pad priv mode mode ext copyright original emphasis
			// onlyMp3Data[i] == FF, the start of this header.

			const mpegVersion = (onlyMp3Data[i + 1] >> 3) & 0b1; // 1 = MPEG 1, 0 = MPEG 2
			const audioLayer = (onlyMp3Data[i + 1] >> 2) & 0b11; // 01 = MP3, 10 = MP2, 01 = MP1

			const hasCRC = onlyMp3Data[i + 1] & 0b1; // 0 = has CRC, 1 = no CRC

			// we frankly do not care at all about joint stereo mode, copyright, or emphasis.
			// ignore the last two bytes.

			// TODO
		}
	})());

</script>